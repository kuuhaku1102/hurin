import os
import openai
import json
import random

# OpenAIクライアントの初期化
client = openai.OpenAI()

def generate_article(article_type):
    """Manus APIを使用して高品質な記事を生成する（HTML形式）"""

    # 記事タイプに応じたキーワードとプロンプトを設定
    if article_type == "usage":
        keywords = "不倫募集掲示板 使い方, セカンドパートナー 見つけ方"
        prompt = f"""「不倫募集掲示板の賢い使い方」というテーマで、SEOに強く、読者の悩みを解決する2500文字以上のブログ記事を作成してください。

【重要な指示】
1. 記事は必ずHTML形式で出力してください（Markdown記法は使用しないでください）
2. 見出しは<h2>、<h3>タグを使用してください
3. 段落は<p>タグで囲んでください
4. 強調したい部分は<strong>タグを使用してください
5. リストは<ul><li>タグを使用してください
6. AIが書いたとバレないように、以下の点に注意してください：
   - 「〜です」「〜ます」調を基本にしつつ、時々「〜だ」「〜である」も混ぜる
   - 完璧すぎる構成ではなく、少し脱線したり、個人的な意見を入れる
   - 「実は」「ちなみに」「正直なところ」などの口語表現を適度に使う
   - 具体的な体験談風の記述を入れる
   - 箇条書きばかりでなく、文章での説明も多めに
7. SEOキーワード「{keywords}」を自然に含めてください
8. タイトルは<h1>タグで、記事の最初に配置してください

【出力形式】
HTMLタグのみで記述し、余計な説明文は一切含めないでください。
<h1>から始まるHTML形式の記事のみを出力してください。
"""
    elif article_type == "spot":
        prefectures = ["北海道", "東京", "大阪", "福岡", "愛知", "神奈川", "京都", "兵庫", "埼玉", "千葉"]
        prefecture = random.choice(prefectures)
        keywords = f"{prefecture} 不倫募集, {prefecture} 出会いスポット"
        prompt = f"""「{prefecture}で不倫募集掲示板で出会える！おすすめの出会いスポット」というテーマで、2500文字以上のブログ記事を作成してください。

【重要な指示】
1. 記事は必ずHTML形式で出力してください（Markdown記法は使用しないでください）
2. 見出しは<h2>、<h3>タグを使用してください
3. 段落は<p>タグで囲んでください
4. 強調したい部分は<strong>タグを使用してください
5. リストは<ul><li>タグを使用してください
6. AIが書いたとバレないように、以下の点に注意してください：
   - 「〜です」「〜ます」調を基本にしつつ、時々「〜だ」「〜である」も混ぜる
   - 完璧すぎる構成ではなく、少し脱線したり、個人的な意見を入れる
   - 「実は」「ちなみに」「正直なところ」などの口語表現を適度に使う
   - 具体的な体験談風の記述を入れる（「私の知人は〜」など）
   - 箇条書きばかりでなく、文章での説明も多めに
7. {prefecture}の具体的な地名やスポット名を含めてください
8. SEOキーワード「{keywords}」を自然に含めてください
9. タイトルは<h1>タグで、記事の最初に配置してください

【出力形式】
HTMLタグのみで記述し、余計な説明文は一切含めないでください。
<h1>から始まるHTML形式の記事のみを出力してください。
"""
    elif article_type == "manner":
        keywords = "不倫マナー, 大人の関係, セカンドパートナー"
        prompt = f"""「大人の関係のマナー」というテーマで、2500文字以上のブログ記事を作成してください。

【重要な指示】
1. 記事は必ずHTML形式で出力してください（Markdown記法は使用しないでください）
2. 見出しは<h2>、<h3>タグを使用してください
3. 段落は<p>タグで囲んでください
4. 強調したい部分は<strong>タグを使用してください
5. リストは<ul><li>タグを使用してください
6. AIが書いたとバレないように、以下の点に注意してください：
   - 「〜です」「〜ます」調を基本にしつつ、時々「〜だ」「〜である」も混ぜる
   - 完璧すぎる構成ではなく、少し脱線したり、個人的な意見を入れる
   - 「実は」「ちなみに」「正直なところ」などの口語表現を適度に使う
   - 具体的な体験談風の記述を入れる
   - 箇条書きばかりでなく、文章での説明も多めに
7. SEOキーワード「{keywords}」を自然に含めてください
8. タイトルは<h1>タグで、記事の最初に配置してください

【出力形式】
HTMLタグのみで記述し、余計な説明文は一切含めないでください。
<h1>から始まるHTML形式の記事のみを出力してください。
"""
    else:
        raise ValueError("無効な記事タイプです")

    # OpenAI APIを呼び出して記事を生成
    response = client.chat.completions.create(
        model="gpt-4.1-mini",
        messages=[
            {"role": "system", "content": "あなたは経験豊富なブロガーです。SEOを意識し、読者の心に響く自然な文体で記事を作成してください。AIが書いたとバレないように、人間味のある表現を心がけてください。"},
            {"role": "user", "content": prompt}
        ],
        temperature=0.8  # より自然でバリエーション豊かな文章を生成
    )

    article_content = response.choices[0].message.content

    # 生成された記事をファイルに保存（HTML形式）
    with open("generated-article.html", "w", encoding="utf-8") as f:
        f.write(article_content)

    print("✅ 高品質な記事を生成しました: generated-article.html")
    return article_content

if __name__ == "__main__":
    import sys
    if len(sys.argv) > 1:
        generate_article(sys.argv[1])
    else:
        print("エラー: 記事タイプを指定してください (usage, spot, manner)")
